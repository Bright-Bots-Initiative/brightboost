// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

generator clientBackend {
  provider = "prisma-client-js"
  output   = "../backend/node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// Identity (Merged Legacy + MVP)
// -----------------------------------------------------------------------------

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  password  String
  role      String   // "teacher" or "student"
  school    String?
  subject   String?
  bio       String   @default("No bio added")
  grade     Int?

  // Legacy / Hybrid Fields (keep for now to avoid breaking old UI)
  xp        Int      @default(0)
  level     String   @default("Explorer")
  streak    Int      @default(0)
  avatarUrl String?  @default("https://api.dicebear.com/7.x/identicon/svg?seed=default")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  enrollments     Enrollment[]
  courses         Course[]      // Teacher's courses
  userBadges      UserBadge[]
  units           Unit[]        // Teacher's units

  // MVP Relations
  progress        Progress[]
  avatar          Avatar?
}

// -----------------------------------------------------------------------------
// MVP: Learning Content (Strict Hierarchy)
// -----------------------------------------------------------------------------

model Module {
  id          String  @id @default(cuid())
  slug        String  @unique
  title       String
  description String
  level       String  // "K-2", "3-5", etc.
  published   Boolean @default(false)
  units       Unit[]
  badges      Badge[]
}

model Unit {
  id       String   @id @default(cuid())
  moduleId String
  title    String
  order    Int
  lessons  Lesson[]
  
  Module      Module   @relation(fields: [moduleId], references: [id])

  // Relations
  teacherId   String
  teacher     User     @relation(fields: [teacherId], references: [id])
  activities  Activity[]

  // Index for filtering lessons by teacher
  @@index([teacherId])
  // Index for filtering units by module
  @@index([moduleId])
}

model Lesson {
  id        String   @id @default(cuid())
  unitId    String
  title     String
  order     Int

  Unit      Unit       @relation(fields: [unitId], references: [id])
  activities Activity[]

  // Index for filtering lessons by unit
  @@index([unitId])
}

model Activity {
  id       String       @id @default(cuid())
  lessonId String
  title    String
  kind     ActivityKind
  order    Int
  content  String?      // JSON or HTML string

  Lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // Explicit relation to Unit to satisfy Unit.activities[]
  unitId   String?
  Unit     Unit? @relation(fields: [unitId], references: [id])

  @@unique([lessonId, order]) // renamed from index to order for clarity
  // Index for filtering activities by unit
  @@index([unitId])
}

// -----------------------------------------------------------------------------
// MVP: Progress & Rewards
// -----------------------------------------------------------------------------

enum ActivityKind {
  INFO
  INTERACT
}

enum ProgressStatus {
  IN_PROGRESS
  COMPLETED
}

model Progress {
  id         String         @id @default(cuid())
  studentId  String
  moduleSlug String
  lessonId   String?
  activityId String
  status     ProgressStatus
  timeSpentS Int            @default(0)
  updatedAt  DateTime       @updatedAt

  User       User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, activityId])
}

// -----------------------------------------------------------------------------
// MVP: Gamification (Avatar + PvP)
// -----------------------------------------------------------------------------

enum Archetype {
  AI
  QUANTUM
  BIOTECH
}

model Avatar {
  id        String    @id @default(cuid())
  studentId String    @unique
  archetype Archetype
  level     Int       @default(1)
  xp        Int       @default(0)
  hp        Int       @default(100)
  energy    Int       @default(100)

  // Loadout/Unlocks
  unlockedAbilities UnlockedAbility[]

  // Matches
  matchesAsP1 Match[] @relation("Player1")
  matchesAsP2 Match[] @relation("Player2")

  User      User @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model Ability {
  id          String   @id @default(cuid())
  name        String
  archetype   Archetype
  reqLevel    Int
  config      Json     // e.g. { type: "attack", value: 10, cooldown: 1 }
  
  unlockedBy  UnlockedAbility[]
}

model UnlockedAbility {
  id        String   @id @default(cuid())
  avatarId  String
  abilityId String
  equipped  Boolean  @default(false)

  Avatar    Avatar  @relation(fields: [avatarId], references: [id], onDelete: Cascade)
  Ability   Ability @relation(fields: [abilityId], references: [id], onDelete: Cascade)

  @@unique([avatarId, abilityId])
}

enum MatchStatus {
  PENDING
  ACTIVE
  COMPLETED
  FORFEIT
}

model Match {
  id        String      @id @default(cuid())
  player1Id String
  player2Id String?
  status    MatchStatus @default(PENDING)
  winnerId  String?
  band      String      // "K2", "G35"
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  Player1   Avatar      @relation("Player1", fields: [player1Id], references: [id])
  Player2   Avatar?     @relation("Player2", fields: [player2Id], references: [id])

  turns     MatchTurn[]

  // Index for frequent lookups of matches by player
  @@index([player1Id])
  @@index([player2Id])
}

model MatchTurn {
  id        String   @id @default(cuid())
  matchId   String
  round     Int
  actorId   String
  action    Json     // { abilityId, damageDealt, ... }
  createdAt DateTime @default(now())

  Match     Match @relation(fields: [matchId], references: [id], onDelete: Cascade)

  // Index for fetching turns of a match (hot path)
  @@index([matchId])
}

// -----------------------------------------------------------------------------
// Legacy / Unused (Kept for Schema Validation if needed, but safe to ignore)
// -----------------------------------------------------------------------------

model Badge {
  id        String   @id @default(cuid())
  moduleId  String
  slug      String   @unique
  name      String
  criteria  String
  iconKey   String
  xpBonus   Int      @default(0)

  Module    Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  UserBadge UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  awardedAt DateTime @default(now())
  
  User      User     @relation(fields: [userId], references: [id])
  Badge     Badge    @relation(fields: [badgeId], references: [id])

  @@unique([userId, badgeId])
}

model Course {
  id        String   @id @default(cuid())
  name      String
  teacherId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  teacher     User         @relation(fields: [teacherId], references: [id])
  enrollments Enrollment[]
  assignments Assignment[]

  // Index for filtering courses by teacher
  @@index([teacherId])
}

model Enrollment {
  id        String   @id @default(cuid())
  studentId String
  courseId  String
  grade     String?
  enrolledAt DateTime @default(now())
  
  student  User   @relation(fields: [studentId], references: [id])
  course   Course @relation(fields: [courseId], references: [id])
  
  @@unique([studentId, courseId])
  // Index for filtering enrollments by course
  @@index([courseId])
}

model Assignment {
  id        String   @id @default(cuid())
  title     String
  dueDate   String
  status    String   // "pending", "completed"
  courseId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  course   Course @relation(fields: [courseId], references: [id])

  // Index for filtering assignments by course
  @@index([courseId])
}

model AuditLog {
  id        String   @id @default(cuid())
  actorId   String?
  action    String
  meta      Json?
  createdAt DateTime @default(now())
}
