name: Production Smoke Test

on:
  workflow_run:
    workflows: ["Azure Static Web Apps CI/CD"]
    types: [completed]
    branches: [main]

env:
  PROD_URL: https://black-sand-053455d1e.6.azurestaticapps.net

jobs:
  smoke:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Test Teacher Dashboard URL
        run: |
          echo "Testing teacher dashboard at ${{ env.PROD_URL }}/teacher"
          response=$(curl -I -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/teacher")
          if [ "$response" != "200" ]; then
            echo "‚ùå Teacher dashboard returned HTTP $response"
            exit 1
          fi
          echo "‚úÖ Teacher dashboard returned HTTP 200"
      
      - name: Test Student Dashboard URL
        run: |
          echo "Testing student dashboard at ${{ env.PROD_URL }}/student"
          response=$(curl -I -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/student")
          if [ "$response" != "200" ]; then
            echo "‚ùå Student dashboard returned HTTP $response"
            exit 1
          fi
          echo "‚úÖ Student dashboard returned HTTP 200"
      
      - name: Test API Endpoints
        run: |
          echo "Testing teacher dashboard API at ${{ env.PROD_URL }}/api/teacher_dashboard"
          response=$(curl -I -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/api/teacher_dashboard")
          if [ "$response" != "200" ]; then
            echo "‚ùå Teacher dashboard API returned HTTP $response"
            exit 1
          fi
          echo "‚úÖ Teacher dashboard API returned HTTP 200"
          
          echo "Testing student dashboard API at ${{ env.PROD_URL }}/api/student_dashboard"
          response=$(curl -I -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/api/student_dashboard")
          if [ "$response" != "200" ]; then
            echo "‚ùå Student dashboard API returned HTTP $response"
            exit 1
          fi
          echo "‚úÖ Student dashboard API returned HTTP 200"
      
      - name: Summary
        run: |
          echo "üéâ All production smoke tests passed!"
          echo "‚úÖ Teacher dashboard: ${{ env.PROD_URL }}/teacher"
          echo "‚úÖ Student dashboard: ${{ env.PROD_URL }}/student"
          echo "‚úÖ Teacher API: ${{ env.PROD_URL }}/api/teacher_dashboard"
          echo "‚úÖ Student API: ${{ env.PROD_URL }}/api/student_dashboard"
