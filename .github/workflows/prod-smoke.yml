name: Production Smoke Test

on:
  workflow_run:
    workflows: ["Azure Static Web Apps CI/CD"]
    types: [completed]
    branches: [main]

env:
  PROD_URL: https://black-sand-053455d1e.6.azurestaticapps.net

jobs:
  smoke:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Test Teacher Dashboard URL
        run: |
          echo "Testing teacher dashboard at ${{ env.PROD_URL }}/teacher"
          response=$(curl -I -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/teacher")
          if [ "$response" != "200" ]; then
            echo "‚ùå Teacher dashboard returned HTTP $response"
            exit 1
          fi
          echo "‚úÖ Teacher dashboard returned HTTP 200"
      
      - name: Test Student Dashboard URL
        run: |
          echo "Testing student dashboard at ${{ env.PROD_URL }}/student"
          response=$(curl -I -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/student")
          if [ "$response" != "200" ]; then
            echo "‚ùå Student dashboard returned HTTP $response"
            exit 1
          fi
          echo "‚úÖ Student dashboard returned HTTP 200"
      
      - name: Test API Authentication
        run: |
          echo "Testing unauthenticated API access returns 401"
          response=$(curl -I -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/api/teacher_dashboard")
          if [ "$response" != "401" ]; then
            echo "‚ùå Teacher dashboard API should return 401 for unauthenticated requests, got HTTP $response"
            exit 1
          fi
          echo "‚úÖ Teacher dashboard API correctly returns HTTP 401 for unauthenticated requests"
          
          response=$(curl -I -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/api/student_dashboard")
          if [ "$response" != "401" ]; then
            echo "‚ùå Student dashboard API should return 401 for unauthenticated requests, got HTTP $response"
            exit 1
          fi
          echo "‚úÖ Student dashboard API correctly returns HTTP 401 for unauthenticated requests"
          
          response=$(curl -I -s -o /dev/null -w "%{http_code}" "${{ env.PROD_URL }}/api/dbtest")
          if [ "$response" != "200" ]; then
            echo "‚ùå dbtest API should remain public, got HTTP $response"
            exit 1
          fi
          echo "‚úÖ dbtest API correctly returns HTTP 200 (remains public)"
      
      - name: Summary
        run: |
          echo "üéâ All production smoke tests passed!"
          echo "‚úÖ Teacher dashboard: ${{ env.PROD_URL }}/teacher"
          echo "‚úÖ Student dashboard: ${{ env.PROD_URL }}/student"
          echo "‚úÖ Teacher API authentication: HTTP 401 (protected)"
          echo "‚úÖ Student API authentication: HTTP 401 (protected)"
          echo "‚úÖ dbtest API: HTTP 200 (public)"
